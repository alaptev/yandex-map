"use strict";

const DEBUG = true
if (DEBUG !== true) { console.log = ()=>{} }

// 1. load json data; resolve(data)
// 2. (data) -> filter the data; resolve(filtered_data)
// 3. (filtered_data) -> init map

$.getJSON("gps_kropotkino.json")
  .then( (dataSet) => {
    console.log('---log--- data = ', dataSet);
    console.log('---log--- dataSet.length = ', dataSet.length)

    function filterDataSet(coords, minDistance) {
      let newCoords = [];
      newCoords.push(coords[0]);
      for (let i = 1; i < coords.length; i++) {
        let distance = getDistance(newCoords[newCoords.length-1], coords[i]);
        if ((distance >= minDistance) || (i === coords.length-1)) {
          newCoords.push(coords[i])
        }
      }
      return newCoords;
    }

    function getDistance(point1, point2) {
      return Math.sqrt( Math.pow((point2[0] - point1[0]), 2) + Math.pow((point2[1] - point1[1]), 2) );
    }

    const filteredDataSet = filterDataSet(dataSet, 0.000003)
    console.log('---log--- filteredDataSet.length = ', filteredDataSet.length)

    return filteredDataSet;
  }).then( (filteredDataSet) => {
    console.log('---log--- filteredDataSet.length = ', filteredDataSet.length)
    ymaps.ready(['AnimatedLine']).then((ymaps) => {
      init_map(ymaps, filteredDataSet);
    })

  });

function init_map(ymaps, filteredDataSet) {
  console.log('---log--- init_map')
  console.log('---log--- filteredDataSet.length = ', filteredDataSet.length)

  // Создаем карту.
  const myMap = new ymaps.Map('map', {
    center: [45.345374032, 40.138917891],
    type: 'yandex#satellite',
    zoom: 19, //25,  // max=19
    controls: [] // карта без элементов управления
  }, {
    searchControlProvider: 'yandex#search'
  })

  // const smallDataSet = [[45.345362928,40.138141166,"2019-11-02 09:40:24.800000"],[45.345364459,40.138140999,"2019-11-02 09:40:25.000000"],[45.345366019,40.13814079,"2019-11-02 09:40:25.200000"],[45.345367694,40.138140536,"2019-11-02 09:40:25.400000"],[45.34536948,40.138140354,"2019-11-02 09:40:25.600000"],[45.345371118,40.13814019,"2019-11-02 09:40:25.800000"],[45.345372736,40.138139958,"2019-11-02 09:40:26.000000"],[45.345374364,40.138139791,"2019-11-02 09:40:26.200000"],[45.345375964,40.138139684,"2019-11-02 09:40:26.400000"],[45.345377522,40.138139498,"2019-11-02 09:40:26.600000"],[45.345379013,40.138139361,"2019-11-02 09:40:26.800000"],[45.34538053,40.138139258,"2019-11-02 09:40:27.000000"],[45.345382182,40.138139163,"2019-11-02 09:40:27.200000"],[45.345383948,40.138139132,"2019-11-02 09:40:27.400000"],[45.345385651,40.138139174,"2019-11-02 09:40:27.600000"],[45.345387181,40.138139204,"2019-11-02 09:40:27.800000"],[45.345388713,40.138139107,"2019-11-02 09:40:28.000000"],[45.345390274,40.138139015,"2019-11-02 09:40:28.200000"],[45.345391901,40.138139023,"2019-11-02 09:40:28.400000"],[45.345393462,40.13813902,"2019-11-02 09:40:28.600000"],[45.345394883,40.138139191,"2019-11-02 09:40:28.800000"],[45.345396409,40.138139203,"2019-11-02 09:40:29.000000"],[45.345398122,40.138139153,"2019-11-02 09:40:29.200000"],[45.345399875,40.138139247,"2019-11-02 09:40:29.400000"],[45.345401646,40.138139367,"2019-11-02 09:40:29.600000"],[45.345403369,40.138139554,"2019-11-02 09:40:29.800000"],[45.345405015,40.138139568,"2019-11-02 09:40:30.000000"],[45.345406584,40.138139616,"2019-11-02 09:40:30.200000"],[45.345408145,40.138139714,"2019-11-02 09:40:30.400000"],[45.345409668,40.138139925,"2019-11-02 09:40:30.600000"],[45.345411235,40.138140112,"2019-11-02 09:40:30.800000"],[45.345412849,40.138140243,"2019-11-02 09:40:31.000000"],[45.345414469,40.138140317,"2019-11-02 09:40:31.200000"],[45.345416077,40.138140484,"2019-11-02 09:40:31.400000"],[45.345417649,40.138140701,"2019-11-02 09:40:31.600000"],[45.345419248,40.138140866,"2019-11-02 09:40:31.800000"],[45.345421012,40.138141043,"2019-11-02 09:40:32.000000"],[45.345422905,40.138141119,"2019-11-02 09:40:32.200000"],[45.345424972,40.138141424,"2019-11-02 09:40:32.400000"],[45.345427216,40.138141616,"2019-11-02 09:40:32.600000"],[45.345429685,40.138141786,"2019-11-02 09:40:32.799999"],[45.345432297,40.138141938,"2019-11-02 09:40:33.000000"],[45.345434989,40.138142006,"2019-11-02 09:40:33.200000"],[45.345437705,40.138142218,"2019-11-02 09:40:33.400000"],[45.345440355,40.138142255,"2019-11-02 09:40:33.600000"],[45.345442968,40.138142191,"2019-11-02 09:40:33.800000"],[45.345445536,40.138142059,"2019-11-02 09:40:34.000000"],[45.345448101,40.138141988,"2019-11-02 09:40:34.200000"],[45.345450688,40.138141854,"2019-11-02 09:40:34.400000"],[45.34545325,40.138141566,"2019-11-02 09:40:34.600000"],[45.345455806,40.138141344,"2019-11-02 09:40:34.800000"],[45.345458447,40.138141047,"2019-11-02 09:40:35.000000"],[45.345461089,40.138140804,"2019-11-02 09:40:35.200000"],[45.345463719,40.13814051,"2019-11-02 09:40:35.400000"],[45.345466333,40.138140169,"2019-11-02 09:40:35.600000"],[45.345468881,40.138139736,"2019-11-02 09:40:35.800000"],[45.345471417,40.138139371,"2019-11-02 09:40:36.000000"],[45.345474119,40.138138947,"2019-11-02 09:40:36.200000"],[45.34547695,40.138138466,"2019-11-02 09:40:36.400000"],[45.345479864,40.138137983,"2019-11-02 09:40:36.600000"],[45.345482761,40.13813737,"2019-11-02 09:40:36.800000"],[45.345485664,40.138136781,"2019-11-02 09:40:37.000000"],[45.345488575,40.138136149,"2019-11-02 09:40:37.200000"],[45.345491477,40.138135513,"2019-11-02 09:40:37.400000"],[45.345494328,40.13813498,"2019-11-02 09:40:37.600000"],[45.345497194,40.138134461,"2019-11-02 09:40:37.800000"],[45.345500184,40.138133876,"2019-11-02 09:40:38.000000"],[45.345503148,40.138133326,"2019-11-02 09:40:38.200000"],[45.345506049,40.138132788,"2019-11-02 09:40:38.400000"],[45.34550898,40.138132237,"2019-11-02 09:40:38.600000"],[45.345512027,40.138131652,"2019-11-02 09:40:38.800000"],[45.345514979,40.138131139,"2019-11-02 09:40:39.000000"],[45.345517952,40.138130541,"2019-11-02 09:40:39.200000"],[45.345520961,40.138129959,"2019-11-02 09:40:39.400000"],[45.34552393,40.138129361,"2019-11-02 09:40:39.600000"],[45.345526849,40.138128841,"2019-11-02 09:40:39.800000"],[45.345529842,40.138128245,"2019-11-02 09:40:40.000000"],[45.345532887,40.138127645,"2019-11-02 09:40:40.200000"],[45.345535865,40.138126997,"2019-11-02 09:40:40.400000"],[45.345538799,40.138126318,"2019-11-02 09:40:40.600000"],[45.345541701,40.138125754,"2019-11-02 09:40:40.800000"],[45.345544568,40.138125086,"2019-11-02 09:40:41.000000"],[45.345547502,40.13812437,"2019-11-02 09:40:41.200000"],[45.345550485,40.138123585,"2019-11-02 09:40:41.400000"],[45.345553637,40.138122787,"2019-11-02 09:40:41.600000"],[45.345556915,40.138121953,"2019-11-02 09:40:41.800000"],[45.345560291,40.138120966,"2019-11-02 09:40:42.000000"],[45.345563638,40.138120021,"2019-11-02 09:40:42.200000"],[45.345567054,40.1381191,"2019-11-02 09:40:42.400000"],[45.345570491,40.138118139,"2019-11-02 09:40:42.600000"],[45.345573905,40.138117276,"2019-11-02 09:40:42.800000"],[45.34557722,40.138116323,"2019-11-02 09:40:43.000000"],[45.345580571,40.138115407,"2019-11-02 09:40:43.200000"],[45.345583939,40.138114511,"2019-11-02 09:40:43.400000"],[45.34558729,40.138113508,"2019-11-02 09:40:43.600000"],[45.345590602,40.138112643,"2019-11-02 09:40:43.800000"],[45.345593949,40.138111801,"2019-11-02 09:40:44.000000"],[45.345597295,40.138110864,"2019-11-02 09:40:44.200000"],[45.345600614,40.13810989,"2019-11-02 09:40:44.400000"],[45.345603961,40.138109181,"2019-11-02 09:40:44.600000"],[45.345607356,40.138108353,"2019-11-02 09:40:44.800000"],[45.345610722,40.13810749,"2019-11-02 09:40:45.000000"],[45.345614073,40.138106713,"2019-11-02 09:40:45.200000"],[45.345617449,40.138105885,"2019-11-02 09:40:45.400000"],[45.345620841,40.138105135,"2019-11-02 09:40:45.600000"],[45.345624236,40.13810424,"2019-11-02 09:40:45.800000"],[45.345627612,40.138103498,"2019-11-02 09:40:46.000000"],[45.345631026,40.138102746,"2019-11-02 09:40:46.200000"],[45.345634426,40.138101989,"2019-11-02 09:40:46.400000"],[45.34563783,40.138101215,"2019-11-02 09:40:46.600000"],[45.345641257,40.138100416,"2019-11-02 09:40:46.800000"],[45.345644675,40.138099641,"2019-11-02 09:40:47.000000"],[45.345648058,40.138098986,"2019-11-02 09:40:47.200000"],[45.345651432,40.138098238,"2019-11-02 09:40:47.400000"],[45.34565483,40.138097604,"2019-11-02 09:40:47.600000"],[45.345658219,40.138096919,"2019-11-02 09:40:47.800000"],[45.345661629,40.138096261,"2019-11-02 09:40:48.000000"],[45.345665075,40.138095541,"2019-11-02 09:40:48.200000"],[45.345668531,40.138094816,"2019-11-02 09:40:48.400000"],[45.345671847,40.138094139,"2019-11-02 09:40:48.600000"],[45.345675157,40.138093528,"2019-11-02 09:40:48.800000"],[45.345678592,40.138092855,"2019-11-02 09:40:49.000000"],[45.345681996,40.138092122,"2019-11-02 09:40:49.200000"],[45.345685338,40.138091465,"2019-11-02 09:40:49.400000"],[45.34568881,40.138090783,"2019-11-02 09:40:49.600000"],[45.345692318,40.138090106,"2019-11-02 09:40:49.800000"],[45.345695739,40.138089494,"2019-11-02 09:40:50.000000"],[45.34569919,40.13808884,"2019-11-02 09:40:50.200000"],[45.345702649,40.138088186,"2019-11-02 09:40:50.400000"],[45.345706078,40.138087516,"2019-11-02 09:40:50.600000"],[45.345709504,40.138086966,"2019-11-02 09:40:50.800000"],[45.345712931,40.138086262,"2019-11-02 09:40:51.000000"],[45.345716343,40.13808575,"2019-11-02 09:40:51.200000"],[45.345719789,40.138085219,"2019-11-02 09:40:51.400000"],[45.345723261,40.138084481,"2019-11-02 09:40:51.600000"],[45.345726741,40.138083923,"2019-11-02 09:40:51.800000"],[45.345730237,40.1380833,"2019-11-02 09:40:52.000000"],[45.345733703,40.138082619,"2019-11-02 09:40:52.200000"],[45.345737141,40.138082099,"2019-11-02 09:40:52.400000"],[45.34574057,40.138081482,"2019-11-02 09:40:52.600000"],[45.345743941,40.138080808,"2019-11-02 09:40:52.800000"],[45.345747305,40.138080392,"2019-11-02 09:40:53.000000"],[45.345750732,40.138079709,"2019-11-02 09:40:53.200000"],[45.345754146,40.13807916,"2019-11-02 09:40:53.400000"],[45.345757524,40.138078502,"2019-11-02 09:40:53.600000"],[45.345760906,40.138078032,"2019-11-02 09:40:53.800000"],[45.345764317,40.13807748,"2019-11-02 09:40:54.000000"],[45.345767668,40.138076832,"2019-11-02 09:40:54.200000"],[45.345771092,40.138076288,"2019-11-02 09:40:54.400000"],[45.345774539,40.138075776,"2019-11-02 09:40:54.600000"],[45.345777951,40.138075214,"2019-11-02 09:40:54.800000"],[45.345781317,40.138074797,"2019-11-02 09:40:55.000000"]]

  // Создаем ломаные линии.
  const animatedLine = new ymaps.AnimatedLine(filteredDataSet, {}, {
    // Задаем цвет.
    strokeColor: '#ED4543',
    // Задаем ширину линии.
    strokeWidth: 4
  })

  // Добавляем линю на карту.
  myMap.geoObjects.add(animatedLine);

  // myMap.events.add('click', function (e) {
  //   animatedLine.geometry.splice(0, 20);
  //   //animatedLine.geometry.remove(0);
  // });

  animatedLine.animate()
}
